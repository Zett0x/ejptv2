
# Búsqueda de Credenciales en Windows (Credential Hunting)

Las credenciales son uno de los objetivos más valiosos durante la escalada de privilegios en sistemas Windows. Encontrarlas puede permitir:

- Obtener acceso administrativo local.
- Moverse lateralmente hacia otros sistemas.
- Escalar privilegios dentro de un dominio Active Directory.

Este documento resume las ubicaciones comunes y técnicas para encontrar credenciales en Windows.

---

## Archivos de Configuración de Aplicaciones

Es frecuente que aplicaciones guarden contraseñas en **texto plano** dentro de archivos de configuración (ej. `.ini`, `.cfg`, `.xml`, `.config`).

**Ejemplo de búsqueda con findstr:**

```powershell
findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml
```

#### Parámetros principales de `findstr`

- **/S** → Busca en el directorio actual y subcarpetas.  
- **/I** → Ignora mayúsculas/minúsculas.  
- **/M** → Muestra solo el nombre del archivo con coincidencia.  
- **/C:"texto"** → Busca la cadena exacta indicada.  
- **/N** → Muestra el número de línea junto a la coincidencia.  
- **/R** → Usa expresiones regulares para la búsqueda.  
- **/P** → Omite archivos con caracteres no imprimibles.  
- **/OFFLINE** → Busca en archivos marcados como offline.

**Ejemplo común:**
```cmd
findstr /SIM "password" *.txt *.ini *.config

También es común encontrar credenciales en `web.config` para IIS:

Ruta común:  
`C:\inetpub\wwwroot\web.config`

---

## Archivos de Diccionario (Chrome)

En Chrome, las palabras agregadas al diccionario del usuario pueden incluir contraseñas escritas en formularios y guardadas para evitar el subrayado rojo.

**Ruta típica:**  
`C:\Users\<usuario>\AppData\Local\Google\Chrome\User Data\Default\Custom Dictionary.txt`

**Búsqueda de contraseñas:**

```powershell
gc 'C:\Users\htb-student\AppData\Local\Google\Chrome\User Data\Default\Custom Dictionary.txt' | Select-String password
```

---

## Archivos de Instalación No Supervisada

Los archivos `unattend.xml` pueden contener credenciales en texto plano o Base64.

**Ejemplo:**

```xml
<AutoLogon>
    <Password>
        <Value>local_4dmin_p@ss</Value>
        <PlainText>true</PlainText>
    </Password>
    <Username>Administrator</Username>
</AutoLogon>
```

Ruta común: `C:\Windows\Panther\unattend.xml`  
(El archivo puede quedar en el sistema después de la instalación).

---

## Historial de PowerShell

PowerShell (desde la versión 5.0 en Windows 10) almacena el historial de comandos en:

`C:\Users\<usuario>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt`

**Comprobar la ruta en el sistema:**

```powershell
(Get-PSReadLineOption).HistorySavePath
```

**Leer el historial de todos los usuarios:**

```powershell
foreach($user in ((ls C:\users).fullname)){
    cat "$user\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt" -ErrorAction SilentlyContinue
}
```

Buscar comandos que incluyan contraseñas en línea, conexiones RDP o autenticaciones manuales.

---

## Credenciales en PowerShell (DPAPI)

PowerShell permite exportar credenciales usando `Export-Clixml`. Esto guarda credenciales cifradas con **DPAPI**, que solo pueden ser descifradas por el mismo usuario en la misma máquina.

### Ejemplo de uso legítimo por administradores

Script `Connect-VC.ps1` para conectarse a un servidor vCenter:

```powershell
# Exportar credenciales
Get-Credential | Export-Clixml -Path 'C:\scripts\pass.xml'

# Usar las credenciales exportadas
$encryptedPassword = Import-Clixml -Path 'C:\scripts\pass.xml'
$decryptedPassword = $encryptedPassword.GetNetworkCredential().Password
Connect-VIServer -Server 'VC-01' -User 'bob_adm' -Password $decryptedPassword
```

### Cómo descifrarlas si tenemos acceso al usuario

Si logramos ejecutar comandos en el contexto del usuario que creó el archivo `pass.xml`, podemos descifrarlo fácilmente:

```powershell
$credential = Import-Clixml -Path 'C:\scripts\pass.xml'
$credential.GetNetworkCredential().username
$credential.GetNetworkCredential().password
```

Salida esperada:

```
bob
Str0ng3ncryptedP@ss!
```

### Limitaciones

- Solo funciona si se ejecuta en la misma máquina y usuario que creó el archivo.
- No puede ser descifrado por otro usuario o en otra máquina (protección DPAPI).

### Técnicas avanzadas

- **Abuso de DPAPI con Mimikatz:**  
  Mimikatz puede extraer las claves maestras DPAPI del proceso `lsass.exe`, permitiendo descifrar `pass.xml` sin necesidad del usuario original.

- **Robo de perfil de usuario:**  
  Si copiamos el directorio completo del usuario (`C:\Users\<usuario>`) y obtenemos acceso al hash NTLM de ese usuario, podemos derivar las claves DPAPI y descifrar las credenciales offline.

---

## Recomendaciones para la defensa

- Evitar guardar contraseñas en texto plano o en archivos exportados sin protección adicional.
- Usar soluciones de gestión de secretos (ej. Vault, KeePass).
- Limitar el historial de PowerShell o deshabilitarlo en sistemas críticos.
- Revisar periódicamente carpetas de configuración en busca de credenciales expuestas.

