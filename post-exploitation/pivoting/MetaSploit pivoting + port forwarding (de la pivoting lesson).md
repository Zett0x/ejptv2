En el laboratorio de pivoting de la pivoting lesson del curso lo hace de la siguiente forma y explicación.
**Pivoting:** Imaginamos que hay un target1 con dos interfaces una 192.168.1.15/24 y otra 10.10.10.34/32. Además hay un target2 con una interfaz 10.10.10.33/32. Desde nuestra máquina atacante tenemos una interfaz en 192.168.1.30/24 por lo que tenemos conexión, o estamos en la misma red que el target1 pero no podremos comunicarnos con el target2.
La solución es usar pivoting, es decir, usar al target1 que tenemos conexión y él tiene con el target2 para establecer conexión con target2.

**portforwarding:** Consiste en, usando la sesión meterpreter de la máquina pivot, redirigir el tráfico del puerto 80 del target2 (al cuál tiene acceso target1), a nuestro puerto x local port ejemplo 1234.

### Pasos añadir ruta metasploit

Después de vulnerar el target1, crearemos una ruta para el target 2 a través de la sesión meterpreter que tenemos en el target1 para eso:
1. Estando en una sesión meterpreter en target1 usamos el comando: 
	`run autoroute -s 10.10.10.0/32` ahí le diremos a la tabla de enrutamiento de metasploit que para acceder a esa red usaremos la sesión meterpreter activa en el target1. Para listar la tabla de enrutamiento de metasploit usamos `run autoroute -p`
2. Ponemos en background la sessión meterpreter y ahora podremos escanear los puertos del target2 usando el módulo:
	`auxiliary/scanner/portscan/tcp` seleccionamos como target el target2 y ejecutamos el escaneo.
	![[Pasted image 20250305113425.png]]
	Ahora sabemos que el target2 tiene el puerto 80 abierto pero no sabemos la versión. Para ello mejor usar nmap scan. Como nmap es una herramienta a parte del metasploit framework, tenemos que usar **portforwarding**

**portforwarding:** Consiste en, usando la sesión meterpreter de la máquina pivot, redirigir el tráfico del puerto 80 del target2 (al cuál tiene acceso target1), a nuestro puerto x local port ejemplo 1234.

1. Volvemos a la sesión meterpreter del target1, y hacemos un port forwarding del puerto 80 del target2 al puerto 1234 de nuestra máquina atacante:
	`portfwd add -l 1234 -p 80 -r 10.10.10.33`
	-l puerto local
	-p puerto de la máquina target2 que queremos traernos localmente
	-r ip del target2
	NOTA: Usar IP no nombre de dominio aunque este en el /etc/hosts de nuestra máquina atacante no funciona. 
	Con `portfwd list` mostramos los portforwarding activos
	
2. Ahora podemos escanear localmente la version del puerto 80 del target2 escaneando con nmap el puerto 1234 de localhost:
	`nmap -sV -p 80 localhost`
	![[Pasted image 20250305114315.png]]


### Continuación de la explotación

Vemos que la versión del servicio http es vulnerable, vamos a explotar esta en concreta usando un módulo exploit de metasploit `exploit/windows/http/badblue_passthru` , establecemos las opciones del exploit, poniendo como rhost la ip del target2, pero como payload no usaremos un reverse_tcp porque nosotros sí podemos pivotar sobre la máquina target1 pero target2 no, por lo que no podrá acceder a nosotros a sí que usaremos un bind_tcp:
`set payload windows/meterpreter/bind_tcp`

Ejecutamos el exploit y listo tenemos acceso, mirando las sesiones activas veremos que tenemos una sesión con el target1 y otra con el target2.
![[Pasted image 20250305114821.png]]
